<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù‚Ù‡ÙˆØ© - Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="theme.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="logo"><div class="logo1"><img src="images/logo1.png" class="logoimg"></div>Ø§Ù„Ù‚Ù‡ÙˆØ©</div>
        <div class="menu-toggle"><i class="fa-solid fa-bars"></i></div>
        <ul class="nav-links">
    <li><a href="index.html"><i class="fa-solid fa-house"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
    <li><a href="dashboard.html"><i class="fa-solid fa-mug-hot"></i> Ø§Ù„ØµØ§Ù„Ø©</a></li>
    <li><a href="profile.html"><i class="fa-solid fa-user"></i> Ø­Ø³Ø§Ø¨ÙŠ</a></li>
</ul>
        <div class="nav-right" id="navAuth"></div>
    </nav>

    <div class="container">
        <div class="profile-layout">
            <aside class="profile-sidebar">
                <ul class="profile-menu" style="margin-top:0;">
                    <li onclick="window.location.href='friends.html'"><i class="fa-solid fa-user-group"></i> Ø§Ù„Ø´Ù„Ø© (Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡)</li>
                    <li onclick="window.location.href='friends-requests.html'"><i class="fa-solid fa-user-plus"></i> Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµØ¯Ø§Ù‚Ø©</li>
                    <li class="active" onclick="window.location.href='notifications.html'"><i class="fa-solid fa-bell"></i> Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</li>
                </ul>
            </aside>

            <main>
                <h1 style="color: var(--primary-blue); margin-bottom: 1.5rem;">Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ğŸ””</h1>
                <div id="notifList">
                    <div style="text-align: center; padding: 2rem;">
                        <i class="fa-solid fa-spinner fa-spin"></i> Ø¨Ù†Ø´ÙˆÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯...
                    </div>
                </div>
            </main>
        </div>
    </div>
<script type="module">
        import { auth, onAuthStateChanged, getNotifications, markNotificationRead } from './auth-service.js';

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("User logged in, fetching notifications..."); // Debug
                await loadNotifs();
            } else {
                window.location.href = 'login.html';
            }
        });

        async function loadNotifs() {
            const list = document.getElementById('notifList');
            // Show loading state
            list.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <i class="fa-solid fa-spinner fa-spin"></i> Ø¨Ù†Ø´ÙˆÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯...
                </div>`;

            const res = await getNotifications();
            console.log("Notifications result:", res); // Debug

            if (!res.success) {
                list.innerHTML = `<div style="text-align: center; padding: 2rem; color: red;">
                    <p>Ø­ØµÙ„ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª: ${res.error}</p>
                </div>`;
                return;
            }
            
            if (res.data.length === 0) {
                list.innerHTML = `<div style="text-align: center; padding: 3rem; color: var(--text-grey);">
                    <i class="fa-regular fa-bell-slash" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                    <p>Ù…ÙÙŠØ´ Ø£Ø®Ø¨Ø§Ø± Ø¬Ø¯ÙŠØ¯Ø©.</p>
                </div>`;
                return;
            }

            list.innerHTML = res.data.map(n => {
                let icon = 'fa-info-circle';
                let content = n.message;
                let action = '';
                let bgColor = n.read ? 'var(--bg-card)' : 'rgba(111, 78, 55, 0.05)'; // Highlight unread
                
                if (n.type === 'friend_request') {
                    icon = 'fa-user-plus';
                    action = `<button class="btn-primary" onclick="window.location.href='friends-requests.html'" style="font-size:0.8rem; padding: 5px 10px;">Ø´ÙˆÙ Ø§Ù„Ø·Ù„Ø¨</button>`;
                } else if (n.type === 'game_invite') {
                    icon = 'fa-gamepad';
                    // Check game type to redirect correctly
                    const link = n.gameType === 'chess' ? `games-chess.html?gameId=${n.gameId}` : `games-xo.html?gameId=${n.gameId}`;
                    action = `<button class="btn-primary" onclick="window.location.href='${link}'" style="font-size:0.8rem; padding: 5px 10px;">Ø§Ù„Ø¹Ø¨</button>`;
                } else if (n.type === 'request_accepted') {
                    icon = 'fa-check-circle';
                }

                // Format timestamp safely
                let timeStr = 'Ø¯Ù„ÙˆÙ‚ØªÙŠ';
                if (n.timestamp) {
                    timeStr = new Date(n.timestamp.toDate()).toLocaleString('ar-EG', {
                        day: 'numeric', month: 'short', hour: 'numeric', minute: 'numeric'
                    });
                }

                return `
                    <div class="uni-card" style="display:flex; gap:15px; align-items:center; padding:1.2rem; border-right: 4px solid ${n.read ? 'transparent' : 'var(--primary-blue)'}; background: ${bgColor}; margin-bottom: 10px; border-radius: 8px;">
                        <div style="font-size:1.4rem; color:var(--primary-blue);"><i class="fa-solid ${icon}"></i></div>
                        <div style="flex:1;">
                            <p style="margin-bottom:4px; font-weight: ${n.read ? 'normal' : 'bold'};">${content}</p>
                            <span style="font-size:0.75rem; color:var(--text-grey);">${timeStr}</span>
                        </div>
                        ${action}
                    </div>
                `;
            }).join('');
            
            // Mark unread as read (in background)
            res.data.forEach(async (n) => {
                if(!n.read) {
                    await markNotificationRead(n.id);
                }
            });
        }
    </script>
    <!-- <script type="module">
        import { auth, onAuthStateChanged, getNotifications, markNotificationRead } from './auth-service.js';

        onAuthStateChanged(auth, async (user) => {
            if (user) loadNotifs();
            else window.location.href = 'login.html';
        });

        async function loadNotifs() {
            const list = document.getElementById('notifList');
            const res = await getNotifications();
            
            if (!res.success || res.data.length === 0) {
                list.innerHTML = `<div style="text-align: center; padding: 3rem; color: var(--text-grey);">
                    <i class="fa-regular fa-bell-slash" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                    <p>Ù…ÙÙŠØ´ Ø£Ø®Ø¨Ø§Ø± Ø¬Ø¯ÙŠØ¯Ø©.</p>
                </div>`;
                return;
            }

            list.innerHTML = res.data.map(n => {
                let icon = 'fa-info-circle';
                let content = n.message;
                let action = '';
                
                if (n.type === 'friend_request') {
                    icon = 'fa-user-plus';
                    action = `<button class="btn-primary" onclick="window.location.href='friends-requests.html'">Ø´ÙˆÙ Ø§Ù„Ø·Ù„Ø¨</button>`;
                } else if (n.type === 'game_invite') {
                    icon = 'fa-gamepad';
                    action = `<button class="btn-primary" onclick="window.location.href='games-xo.html?gameId=${n.gameId}'">Ø§Ù„Ø¹Ø¨ Ø¯ÙŠÙ„ÙˆÙ‚ØªÙŠ</button>`;
                } else if (n.type === 'request_accepted') {
                    icon = 'fa-check-circle';
                }

                return `
                    <div class="uni-card" style="display:flex; gap:15px; align-items:center; padding:1.5rem; border-left: 5px solid ${n.read ? '#ccc' : 'var(--primary-blue)'}; margin-bottom: 10px;">
                        <div style="font-size:1.5rem; color:var(--primary-blue);"><i class="fa-solid ${icon}"></i></div>
                        <div style="flex:1;">
                            <p style="margin-bottom:5px;">${content}</p>
                            <span style="font-size:0.8rem; color:var(--text-grey);">${n.timestamp ? new Date(n.timestamp.toDate()).toLocaleString('ar-EG') : 'Ø¯Ù„ÙˆÙ‚ØªÙŠ'}</span>
                        </div>
                        ${action}
                    </div>
                `;
            }).join('');
            
            // Mark unread as read
            res.data.forEach(n => {
                if(!n.read) markNotificationRead(n.id);
            });
        }
    </script> -->
        <script type="module" src="profile-load.js"></script>

    <script src="script.js"></script>
</body>
</html>